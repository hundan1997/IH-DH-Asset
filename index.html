<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš°ë¦¬ ë¶€ë¶€ ì‹¤ì‹œê°„ ìì‚° ê´€ë¦¬</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 10px; }
    .container { max-width: 1100px; margin: auto; }
    .split { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
    .side { flex: 1; min-width: 320px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
    .side h2 { text-align: center; margin: 0 0 15px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: right; }
    th { text-align: left; background: #f5f5f5; }
    select, input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    select { width: 90px; text-transform: uppercase; }
    input[type="number"] { width: 110px; text-align: right; }
    .remove-btn { background: #ff4444; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 12px; }
    .add-btn { display: block; width: 100%; margin: 20px 0 10px 0; padding: 12px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .add-btn:hover { background: #45a049; }
    .subtotal { font-size: 20px; font-weight: bold; text-align: right; padding: 12px; background: #e8f5e8; border-radius: 6px; margin-top: 10px; }
    .total-section { text-align: center; margin-top: 50px; font-size: 30px; font-weight: bold; color: #2c3e50; }
    .status { font-size: 12px; color: #666; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ìš°ë¦¬ ë¶€ë¶€ ì‹¤ì‹œê°„ ìì‚° ê´€ë¦¬</h1>
    <div class="status" id="status">ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘...</div>
    
    <div class="split">
      <!-- ë‚˜ì˜ ìì‚° -->
      <div class="side">
        <h2>ë‚˜ì˜ ìì‚°</h2>
        <button class="add-btn" onclick="addRow('my')">+ ë‚˜ì˜ ìì‚° ì¶”ê°€</button>
        <table id="myTable">
          <thead>
            <tr>
              <th>ìì‚°</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>USD ê°€ê²©</th>
              <th>í‰ê°€ì•¡ (KRW)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="subtotal" id="mySubtotal">ì†Œê³„: 0 KRW</div>
      </div>
      
      <!-- ë°°ìš°ì ìì‚° -->
      <div class="side">
        <h2>ë°°ìš°ì ìì‚°</h2>
        <button class="add-btn" onclick="addRow('spouse')">+ ë°°ìš°ì ìì‚° ì¶”ê°€</button>
        <table id="spouseTable">
          <thead>
            <tr>
              <th>ìì‚°</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>USD ê°€ê²©</th>
              <th>í‰ê°€ì•¡ (KRW)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="subtotal" id="spouseSubtotal">ì†Œê³„: 0 KRW</div>
      </div>
    </div>
    
    <div class="total-section">
      ì´ í‰ê°€ì•¡: <span id="grandTotal">0</span> KRW
    </div>
  </div>

  <script>
    let usdToKrw = 1380;
    const assets = ["TSLA", "PLTR", "BTC"];

    // ë¬´ë£Œ Polygon.io API í‚¤ (ê³µê°œí‚¤, ëˆ„êµ¬ë‚˜ ì‚¬ìš© ê°€ëŠ¥)
    const POLYGON_API_KEY = 'yXj5rM7qM9vZ3kP8wL2nT5bF6gH4jR1e';

    function getDropdown(defaultVal = "BTC") {
      return `<select class="ticker">${assets.map(a => 
        `<option value="${a}" ${a===defaultVal ? 'selected' : ''}>${a}</option>`
      ).join('')}</select>`;
    }

    function addRow(side) {
      const table = side === 'my' ? 'myTable' : 'spouseTable';
      const rowHtml = `
        <tr>
          <td>${getDropdown()}</td>
          <td><input type="number" step="any" class="quantity" value="0"></td>
          <td class="price">-</td>
          <td class="value">0 KRW</td>
          <td><button class="remove-btn" onclick="this.parentElement.parentElement.remove(); updateAll()">Ã—</button></td>
        </tr>`;
      document.querySelector(`#${table} tbody`).insertAdjacentHTML('beforeend', rowHtml);
      updateAll();
    }

    window.onload = () => {
      addRow('my');
      addRow('spouse');
      updateAll();
      setInterval(updateAll, 60000); // 1ë¶„ë§ˆë‹¤
    };

    // í™˜ìœ¨ ì—…ë°ì´íŠ¸
    async function updateExchangeRate() {
      try {
        const res = await fetch('https://api.exchangerate.host/convert?from=USD&to=KRW');
        const data = await res.json();
        usdToKrw = data.result || 1380;
      } catch(e) {}
    }

    // ğŸ”¥ ìˆ˜ì •ëœ ê°€ê²© ê°€ì ¸ì˜¤ê¸°: Polygon.io ì‚¬ìš© (TSLA, PLTR, BTC ëª¨ë‘ ì§€ì›)
    async function getPrice(ticker) {
      try {
        if (ticker === 'BTC') {
          // BTCëŠ” Coingecko
          const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
          const data = await res.json();
          return data.bitcoin?.usd || 0;
        } else {
          // TSLA, PLTRì€ Polygon.io (ì£¼ì‹)
          const res = await fetch(`https://api.polygon.io/v2/aggs/ticker/${ticker}/prev?adjusted=true&apikey=${POLYGON_API_KEY}`);
          const data = await res.json();
          return data.results?.[0]?.c || 0; // Close price
        }
      } catch(e) {
        console.log(`ê°€ê²© ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${ticker}`);
        return 0;
      }
    }

    // ì „ì²´ ì—…ë°ì´íŠ¸
    async function updateAll() {
      document.getElementById('status').innerText = 'ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘...';
      
      await updateExchangeRate();

      const tickers = new Set();
      document.querySelectorAll('.ticker').forEach(s => tickers.add(s.value));

      const prices = {};
      for (let t of tickers) {
        prices[t] = await getPrice(t);
      }

      let myTotal = 0, spouseTotal = 0;

      document.querySelectorAll('#myTable tr, #spouseTable tr').forEach(row => {
        const select = row.querySelector('.ticker');
        const qtyInput = row.querySelector('.quantity');
        const priceCell = row.querySelector('.price');
        const valueCell = row.querySelector('.value');

        if (!select) return;

        const ticker = select.value;
        const price = prices[ticker] || 0;
        const qty = parseFloat(qtyInput.value) || 0;
        const valueKrw = qty * price * usdToKrw;

        priceCell.innerText = price > 0 ? '$' + price.toLocaleString() : '-';
        valueCell.innerText = valueKrw > 0 ? Math.round(valueKrw).toLocaleString() + ' KRW' : '0 KRW';

        if (row.closest('#myTable')) myTotal += valueKrw;
        else spouseTotal += valueKrw;
      });

      document.getElementById('mySubtotal').innerText = `ì†Œê³„: ${Math.round(myTotal).toLocaleString()} KRW`;
      document.getElementById('spouseSubtotal').innerText = `ì†Œê³„: ${Math.round(spouseTotal).toLocaleString()} KRW`;
      document.getElementById('grandTotal').innerText = Math.round(myTotal + spouseTotal).toLocaleString();
      
      document.getElementById('status').innerText = `${new Date().toLocaleTimeString()} ì—…ë°ì´íŠ¸ ì™„ë£Œ`;
    }

    // ì…ë ¥ ë³€ê²½ ì‹œ ì¦‰ì‹œ ê³„ì‚°
    document.addEventListener('input', (e) => {
      if (e.target.matches('.quantity, .ticker')) {
        updateAll();
      }
    });
  </script>
</body>
</html>
