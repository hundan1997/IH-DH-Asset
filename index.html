<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>우리 부부 실시간 자산 관리</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 10px; }
    .container { max-width: 1100px; margin: auto; }
    .split { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
    .side { flex: 1; min-width: 320px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
    .side h2 { text-align: center; margin: 0 0 15px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: right; }
    th { text-align: left; background: #f5f5f5; }
    select, input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    select { width: 90px; text-transform: uppercase; }
    input[type="number"] { width: 110px; text-align: right; }
    .remove-btn { background: #ff4444; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 12px; }
    .add-btn { display: block; width: 100%; margin: 20px 0 10px 0; padding: 12px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .add-btn:hover { background: #45a049; }
    .subtotal { font-size: 20px; font-weight: bold; text-align: right; padding: 12px; background: #e8f5e8; border-radius: 6px; margin-top: 10px; }
    .total-section { text-align: center; margin-top: 50px; font-size: 30px; font-weight: bold; color: #2c3e50; }
  </style>
</head>
<body>
  <div class="container">
    <h1>우리 부부 실시간 자산 관리</h1>
    
    <div class="split">
      <!-- 나의 자산 -->
      <div class="side">
        <h2>나의 자산</h2>
        <button class="add-btn" onclick="addRow('my')">+ 나의 자산 추가</button>
        <table id="myTable">
          <thead>
            <tr>
              <th>자산</th>
              <th>수량</th>
              <th>USD 가격</th>
              <th>평가액 (KRW)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="subtotal" id="mySubtotal">소계: 0 KRW</div>
      </div>
      
      <!-- 배우자 자산 -->
      <div class="side">
        <h2>배우자 자산</h2>
        <button class="add-btn" onclick="addRow('spouse')">+ 배우자 자산 추가</button>
        <table id="spouseTable">
          <thead>
            <tr>
              <th>자산</th>
              <th>수량</th>
              <th>USD 가격</th>
              <th>평가액 (KRW)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="subtotal" id="spouseSubtotal">소계: 0 KRW</div>
      </div>
    </div>
    
    <div class="total-section">
      총 평가액: <span id="grandTotal">0</span> KRW
    </div>
  </div>

  <script>
    let usdToKrw = 1380; // 실시간 업데이트됨

    const assets = ["TSLA", "PLTR", "BTC"];

    // 드롭다운 HTML 생성
    function getDropdown(defaultVal = "BTC") {
      return `<select class="ticker">${assets.map(a => 
        `<option value="${a}" ${a===defaultVal ? 'selected' : ''}>${a}</option>`
      ).join('')}</select>`;
    }

    // 행 추가
    function addRow(side) {
      const table = side === 'my' ? 'myTable' : 'spouseTable';
      const rowHtml = `
        <tr>
          <td>${getDropdown()}</td>
          <td><input type="number" step="any" class="quantity" value="0"></td>
          <td class="price">-</td>
          <td class="value">0 KRW</td>
          <td><button class="remove-btn" onclick="this.parentElement.parentElement.remove(); updateAll()">×</button></td>
        </tr>`;
      document.querySelector(`#${table} tbody`).insertAdjacentHTML('beforeend', rowHtml);
      updateAll();
    }

    // 페이지 로드 시 기본 행 하나씩 추가
    window.onload = () => {
      addRow('my');
      addRow('spouse');
      updateExchangeRate();
      setInterval(updateAll, 60000); // 1분마다 자동 업데이트
    };

    // 환율 업데이트
    async function updateExchangeRate() {
      try {
        const res = await fetch('https://api.exchangerate.host/convert?from=USD&to=KRW');
        const data = await res.json();
        usdToKrw = data.result || 1380;
      } catch(e) { console.log('환율 실패'); }
    }

    // 가격 가져오기
    async function getPrice(ticker) {
      ticker = ticker.toUpperCase();
      let id = ticker.toLowerCase();
      if (ticker === 'BTC') id = 'bitcoin';

      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`);
        const data = await res.json();
        return data[id]?.usd || 0;
      } catch {
        // 주식(TSLA, PLTR)은 Coingecko에서 안 될 수 있으니 Yahoo fallback
        if (ticker === 'TSLA' || ticker === 'PLTR') {
          try {
            const yRes = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=1d&interval=1d`);
            const yData = await yRes.json();
            return yData.chart.result[0].meta.regularMarketPrice || 0;
          } catch { return 0; }
        }
        return 0;
      }
    }

    // 전체 업데이트
    async function updateAll() {
      await updateExchangeRate();

      const tickers = new Set();
      document.querySelectorAll('.ticker').forEach(s => tickers.add(s.value));

      const prices = {};
      for (let t of tickers) prices[t] = await getPrice(t);

      let myTotal = 0, spouseTotal = 0;

      document.querySelectorAll('#myTable tr, #spouseTable tr').forEach(row => {
        const select = row.querySelector('.ticker');
        const qtyInput = row.querySelector('.quantity');
        const priceCell = row.querySelector('.price');
        const valueCell = row.querySelector('.value');

        if (!select) return;

        const ticker = select.value;
        const price = prices[ticker] || 0;
        const qty = parseFloat(qtyInput.value) || 0;
        const valueKrw = qty * price * usdToKrw;

        priceCell.innerText = price > 0 ? '$' + price.toLocaleString() : '-';
        valueCell.innerText = valueKrw > 0 ? valueKrw.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' KRW' : '0 KRW';

        if (row.closest('#myTable')) myTotal += valueKrw;
        else spouseTotal += valueKrw;
      });

      document.getElementById('mySubtotal').innerText = `소계: ${myTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} KRW`;
      document.getElementById('spouseSubtotal').innerText = `소계: ${spouseTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} KRW`;
      document.getElementById('grandTotal').innerText = (myTotal + spouseTotal).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // 입력 변경 시 실시간 계산
    document.addEventListener('input', (e) => {
      if (e.target.matches('.quantity') || e.target.matches('.ticker')) {
        updateAll();
      }
    });

    // 초기 업데이트
    setTimeout(updateAll, 1000);
  </script>
</body>
</html>
